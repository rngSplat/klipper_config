[idle_timeout]
gcode:
   #  lights_off
   #  STATUS_OFF
   TURN_OFF_HEATERS
   M84
timeout: 1200

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
   M104 S0
   M140 S0
   M106 S0
   CLEAR_PAUSE
   M84
   #  STATUS_OFF
   BASE_CANCEL_PRINT

[gcode_macro DISABLE_MOTORS]
gcode:
   M18


[gcode_macro START_PRINT]
gcode:
   {% set bed_temp = params.BED_TEMP|default(60)|float %} #[first_layer_bed_temperature]
   {% set extruder_temp = params.EXTRUDER_TEMP|default(190)|float %} #[first_layer_temperature]
   # Start bed heating
   M190 S{bed_temp}
   M104 S155
   # Use absolute coordinates
   G90
   # Home the printer
   G28
#  BED_TILT_CALIBRATE
   BED_MESH_CALIBRATE
   @BEDLEVELVISUALIZER	; instruct plugin to start recording responses from printer.
   BED_MESH_output		; report the bed leveling mesh points.
   # Move the nozzle near the bed
   G1 X1 Y25 Z5 F3000
   # Move the nozzle very close to the bed
   G1 Z0.15 F300
   # Set and wait for nozzle to reach temperature
   M109 S{extruder_temp}
   PRIME_LINE

[gcode_macro END_PRINT]
gcode:
   # Move nozzle away from print while retracting
   G91
   G1 X-2 Y-2 E-1 F300
   triple_beep
   # Raise nozzle by 0mm
   G1 Z20 F3000
   G90
   G1 X10 Y250
   # Disable steppers
   M84
   # Turn off bed, extruder, and fan
   M140 S0
   M104 S0
   M106 S0


############################################################################
# Sound Macros #
############################################################################

[gcode_macro M300]
gcode:
   {% set s = params.S|default(440)|float %} #   Use a default 440Hz tone if S is omitted.
   {% set p = params.P|default(1000)|float %} #   Use a 10ms duration if P is omitted.
   {% if s|float > 0 %}
      SET_PIN PIN=BEEPER_pin VALUE=500 cycle_time={ 1 / s|float }
   {% endif %}
   G4 P{p}
   SET_PIN PIN=BEEPER_pin VALUE=0

[gcode_macro triple_beep]
gcode:
   M300 P100
   G4 P100
   M300 P50
   G4 P100
   M300 P100

[gcode_macro long_beep]
gcode:
   M300 P3000 S500

######################################################################
# Debugging Macros
######################################################################

[gcode_macro DUMP_VARS]
gcode:
   {% for name1 in printer %}
      {% for name2 in printer[name1] %}
         { action_respond_info("printer['%s'].%s = %s" % (name1, name2, printer[name1][name2])) }
      {% endfor %}
   {% endfor %}

[gcode_macro DUMP_CONFIG_VARS]
gcode:
   {% for name1 in printer['configfile'].config %}
      #{% for name2 in printer[name1] %}
         { action_respond_info("printer['configfile'].%s" % (name1)) }
      #{% endfor %}
   {% endfor %}


######################################################################
# Filament Change
######################################################################


# M600: Filament Change. This macro will pause the printer, move the
# tool to the change position, and retract the filament 130mm. Adjust
# the retraction settings for your own extruder. After filament has
# been changed, the print can be resumed from its previous position
# with the "RESUME" gcode.

[gcode_macro M600]
gcode:
   {% set x = params.X|default(-2)|float %} #park position
   {% set y = params.Y|default(220)|float %} #park position
   {% set z = params.Z|default(20)|float %} #park position
   {% set e = params.E|default(-60)|float %} #retract dist
   SAVE_GCODE_STATE NAME=M600_state
   PAUSE
   G91
   G1 E-5 F4000
   G1 Z{z}
   G90
   G1 X{x} Y{y} F7800        ;park position
   G91
   G0 E5.2 F600                ;extrude filament to get better blob on end
   G0 E{e} F4000             ;retract additional filament to move out of melt zone
   G92 E0
   G90
   SET_IDLE_TIMEOUT TIMEOUT=43200
   status_busy
   long_beep

#    Use this command resume during a mid print filament swap (DONT USE OCTO/MAINSAIL/DWC RESUME)
[gcode_macro SWAP_RESUME] 
gcode:
   RESTORE_GCODE_STATE NAME=M600_state
   SET_IDLE_TIMEOUT TIMEOUT=1200
   #  status_printing
   resume

######################################################################
# load / unload filament
######################################################################


#    Macro to Load Filament
[gcode_macro load_filament]
gcode:
   {% set extruder = params.EXTRUDER|default(200)|float %}
   {% set x = params.X|default(-134)|float %}
   {% set y = params.Y|default(0)|float %}
   {% set z = params.Z|default(10)|float %}
   {% set e = params.E|default(50)|float %}   
   G90
   G0 X{x} Y{y}                #move to area where you can easily load filament
   M109 S{extruder}            #set hotend temperature and wait
   M83                         #relative positioning on extruder    
   G0 E{e} F400                #prime extruder
   G92 E0

#    Macro to Unload Filament
[gcode_macro unload_filament]
gcode:
   {% set extruder = params.EXTRUDER|default(200)|float %}
   {% set x = params.X|default(-134)|float %}
   {% set y = params.Y|default(0)|float %}
   {% set z = params.Z|default(10)|float %}
   {% set e = params.E|default(-50)|float %}
   G0 X{X} Y{Y}                #move to area where you can easily load filament
   M109 S{EXTRUDER}            #set hotend temperature and wait    
   M83                         #relative positioning on extruder
   G0 E15 F400                 #extrude filament to get better blob on end
   G0 E{E} F1000               #retract additional filament to move out of melt zone
   G92 E0

######################################################################
# Prime Line
######################################################################
[gcode_macro PRIME_LINE]
gcode:
   #Get Printer built volume dimensions
   {% set X_MAX = printer.toolhead.axis_maximum.x|default(100)|float %}
   {% set Y_MAX = printer.toolhead.axis_maximum.y|default(100)|float %}
   {% set Z_MAX = printer.toolhead.axis_maximum.z|default(100)|float %}

   #Get Nozzle diameter and filament width for conditioning
   {% set NOZZLE = printer.extruder.nozzle_diameter|default(0.4)|float %}
   {% set FILADIA = printer.extruder.filament_diameter|default(1.75)|float %}

   #Set Start coordinates of priming lines
   {% set X_START = 1|default(1)|float %}
   {% set Y_START = 25|default(0.0)|float %}

   #Calculate Primer line extrusion volume and filament length
   {% set PRIMER_WIDTH = 1.05 * NOZZLE %}
   {% set PRIMER_HEIGHT = 0.80 * NOZZLE %}
   {% set PRIMER_SECT = PRIMER_WIDTH * PRIMER_HEIGHT %}
   {% set PRIMER_VOL = PRIMER_SECT * (Y_MAX - 50 - Y_START) %}
   {% set FILA_SECT = 3.1415 * ( FILADIA / 2.0)*2 %}
   {% set FILA_LENGTH = 1.55 * PRIMER_VOL / FILA_SECT %}


   #Precondition extruder
   M83
   G1 X{X_START} Y{Y_START} Z{PRIMER_HEIGHT} F7800
   G1 X{X_START} Y{Y_MAX - 50} Z{PRIMER_HEIGHT} F1500.0 E{FILA_LENGTH}
   G1 X{X_START + PRIMER_WIDTH} Y{Y_MAX - 50} Z{PRIMER_HEIGHT} F5000.0
   G1 X{X_START + PRIMER_WIDTH} Y{Y_START} Z{PRIMER_HEIGHT} F1500.0 E{FILA_LENGTH}
   M82
   G92 E0